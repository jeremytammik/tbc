<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js" type="text/javascript"></script>
</head>

<!---

- Revit 2023: Parameters Service
  https://youtu.be/cRz7kQz88mA
  2:36 video
  Manage your parameters library more efficiently across projects and locations using the Parameters Service with Revit and the Autodesk Construction Cloud

- 2023 parameters:
  Jesika DiGregorio
  This post is part of my ongoing effort to be proactively prepared for the transition from BuiltInParameter to the ForgeTypeId equivalent ParameterTypeId.
  I have a few questions about how modifications to the ParameterTypeId will be documented. I am trying to ensure that if I reference a particular parameter by ParameterTypeId I can track when I need to handle a change between Revit versions and the new value that should be used, as well as write code to translate serialization that may have been generated by a different version of Revit.
  1. Currently when a BuiltInParameter value is renamed I can easily tell by comparing the enumeration between 2 versions and seeing that two values with the same numeric value have a different enumeration value. The ParameterTypeId doesn't have a corresponding value that can help track renames and there is currently no note in the summary indicating it was renamed. What technique should we use to correlate such a change between Revit versions and now that it was a rename rather than a drop and add?
  Example:
  * 2022 Revit: "Electrial Load Zone Type" 
  RBS_ELECTRICAL_LOAD_ZONE_TYPE = -1153533 
  ParameterTypeId.RbsElectricalLoadZoneType
  * December Preview Build: "Area Based Load Type" 
  RBS_AREA_BASED_LOAD_TYPE = -1153533 
  ParameterTypeId.RbsAreaBasedLoadType
  2. BuiltInParameter has a few "equivalents", values with different names but the same numeric values. Will ParameterTypeId have a similar implementation in the future? In the December Preview Build, it appears that the ParameterTypeId references were renamed in the cases where an equivalent was added to BuiltInParameter for that value.
  Example:
  * Revit 2022: "Spot Top Elevation with Insulation"
  FABRICATION_SPOT_TOP_ELEVATION_INCLUDE_INSULATION_OF_PART = -1140985
  ParameterTypeId.FabricationSpotTopElevationIncludeInsulationOfPart
  * December Preview Build: "Spot Top of Insulation Elevation"
  FABRICATION_SPOT_TOP_ELEVATION_INCLUDE_INSULATION_OF_PART = -1140985
  MEP_SPOT_TOP_ELEVATION_INCLUDE_INSULATION = -1140985
  ParameterTypeId.MepSpotTopElevationIncludeInsulation
  3. If I have an older (from 2022) ForgeTypeId.TypeId value stored for a ParameterTypeId that has been renamed in the new version, will the new version of Revit know that it is equivalent to the one with the new name? 
  Specifically using the old value to create a ForgeTypeId and then either comparing it to one retrieved from a parameter definition using NameEquals(ForgeTypeId other) or use it to call Element.GetParameter(ForgeTypeId parameterTypeId)? 
  I understand the the older version of Revit won't know, but only having one direction to manage is better than both.
  Dec 22, 2021 @ 3:30 PM	 
  David Becroft
  The Factory
  Unified Parameters Service - INTERNAL
  Good morning Jesika, these are great questions, and a Happy New Year to you! You've nailed it, and I hope the rest of my answer won't bum you out too much. Because of the issues you describe, only the ElementId will identify a built-in parameter consistently across Revit versions. The ForgeTypeId string of a built-in parameter is generated from the parameter's symbolic identifier. In your first example, the symbolic identifier changes from one release to the next. In your second example, a new symbolic identifier is introduced and the original one is treated as an alias, but only the new one produces a ForgeTypeId string. To recover the underlying ElementId from a ForgeTypeId string, use [code]ParameterUtils.GetBuiltInParameter(ForgeTypeId)[/code]. For the opposite conversion, use [code]ParameterUtils.GetParameterTypeId(BuiltInParameter)[/code]. 
  To your third question: No, Revit does not know that the old and new ForgeTypeId strings correspond to the same ElementId. [code]ForgeTypeId.NameEquals(ForgeTypeId)[/code] behaves the same way as the default equality comparison operator for ForgeTypeId objects; it simply compares the strings inside the two ForgeTypeId objects while ignoring their version numbers. [code]Element.GetParameter(ForgeTypeId)[/code] maps the given ForgeTypeId to its corresponding ElementId before searching for the matching parameter, but it does not have a record of legacy ForgeTypeId strings for built-in parameters.
  Jan 4, 2022 @ 9:46 AM

- tired of struggling with the Revit add-in security warning about an unsigned add-in saying, the publisher of this add-in could not be verified?
KONRAD SOBON of [archi+lab](https://archi-lab.net) explains how
to [Create a Self-signed Code Signing Certificate](https://archi-lab.net/creating-a-self-signed-code-signing-certificate) for free, valid for the next 17 years or so:
> ... <i>[detailed explanation]</i> ... That’s it! That should create your PFX file that you can now use with signtool, and code sign your Revit plugins for free! This self signed code signing certificate won’t expire for another 17 years so you should be good to go for a while.
Now, be aware of the fact that this self-signed code signing certificate is not the same as one issued to you by a 3rd party. I guess the level of “trust” here would be a little different, but in this particular case, I don’t think it matters to me. I am fed up with paying money to companies that have just atrocious customer support. If you are using these code signing certificates literally to just sign Revit plugins, then there is no reason to obtain one from a 3rd party and pay a hefty price for it on top of all the hoops that they will make you jump through.
I hope this helps some of the AEC development community out there save some money and time.

- main discussion forumthread on resolving this + other threads

- thesde threads mentioined before?

- code snippets
Maycon Freitas
Architect | Dynamo, Revit API Developer & Forge Enthusiast | Blossom Consult
Maycon Freitas  5:23 PM

Hi Jeremy, how are you?
I'm creating this repository on github to share Revit API code snippets with our Revit developers community.
If you're interested in contributing somehow, I would really appreciate.
The idea is to create an open source project to help developers to improve coding performance.
Best regards,
Maycon Freitas.

https://youtu.be/moD7CYUkJHw

RevitAPISnippets: 170+ code lines in 2 minutes (Revit API)

18 May 2022
An example of the use of Revit API snippet codes in Visual Studio.
Using snippets to improve coding performance in Revit API development.

Github Repo:

https://github.com/mayconrfreitas/RevitAPISnippets

Develop Branch with the snippets:

https://github.com/mayconrfreitas/RevitAPISnippets/tree/develop/Snippets/RevitAPI2020

- batch processing and monitoring progress
  Way to check if family is corrupt
  https://forums.autodesk.com/t5/revit-api-forum/way-to-check-if-family-is-corrupt/m-p/11174180

twitter:

the #RevitAPI SDK @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon 

&ndash;
...

linkedin:

#bim #DynamoBim #ForgeDevCon #Revit #API #IFC #SDK #AI #VisualStudio #Autodesk #AEC #adsk

the [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread

<center>
<img src="img/" alt="" title="" width="600" height=""/>
<p style="font-size: 80%; font-style:italic"></p>
</center>

-->

### Parameters, Code Snippets, Batch Mode and Self-Signing

Picking up some specaly interesting topics from
the [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) and
elsewhere:

- [Revit 2023 parameters service](#2)
- [Roll your own verified publisher](#3)
- [Revit API code snippet repository](#4)
- [Batch processing and monitoring progress](#5)

####<a name="2"></a> Revit 2023 Parameters Service

In Revit 2023, a new cloud-based parameters service is under evaluation.

Learn all about it in the two-and-a-half-minute video
on [Revit 2023 Parameters Service](https://youtu.be/cRz7kQz88mA).

> Manage your parameters library more efficiently across projects and locations using the Parameters Service with Revit and the Autodesk Construction Cloud

It’s currently in a preview phase with no API, yet.
API support will presumably be coming along after the evaluation phase.

####<a name="3"></a> Roll Your Own Verified Publisher

Are you getting tired of struggling with the Revit add-in security warning about an unsigned add-in saying, *the publisher of this add-in could not be verified*?

Konrad Sobon of [archi+lab](https://archi-lab.net) explains how
to [create a self-signed code signing certificate](https://archi-lab.net/creating-a-self-signed-code-signing-certificate) for yourself for free:

> ... <i>[detailed explanation]</i> ... That’s it!
That should create your PFX file that you can now use with signtool, and code sign your Revit plugins for free!
This self signed code signing certificate won’t expire for another 17 years so you should be good to go for a while.
Now, be aware of the fact that this self-signed code signing certificate is not the same as one issued to you by a 3rd party.
I guess the level of “trust” here would be a little different, but in this particular case, I don’t think it matters to me.
I am fed up with paying money to companies that have just atrocious customer support.
If you are using these code signing certificates literally to just sign Revit plugins, then there is no reason to obtain one from a 3rd party and pay a hefty price for it on top of all the hoops that they will make you jump through.
I hope this helps some of the AEC development community out there save some money and time.

Thank you very much, Konrad for digging in so deep and sharing this very helpful approach!

For the sake of completeness, you can also check out
Konrad's previous post on [code signing of your Revit plug-ins](http://archi-lab.net/code-signing-of-your-revit-plug-ins),
the main [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread
on [Code signing of Revit Addins](https://forums.autodesk.com/t5/revit-api-forum/code-signing-of-revit-addins/m-p/5981560)
and previous articles on this by The Building Coder:

<ul>
<li><a href="http://thebuildingcoder.typepad.com/blog/2016/04/whats-new-in-the-revit-2017-api.html#2.4">What's New in the Revit 2017 API &ndash; Code signing of Revit Addins</a></li>
<li><a href="http://thebuildingcoder.typepad.com/blog/2016/09/trusted-signature-motivation-and-fishing.html#2">How Does Code Signing of Revit Add-Ins Increase Security?</a></li>
<li><a href="https://thebuildingcoder.typepad.com/blog/2020/09/code-signing-preview-and-element-type-predicates.html#2">Revit Add-In Code Signing YAML</a> to automate code signing in CI</li>
</ul>

####<a name="4"></a> Revit API Code Snippet Repository

Maycon Freitas, architect, Dynamo, Revit API Developer and Forge enthusiast at [Blossom Consult](https://www.blossomconsult.com),
shares a new collection of Revit API code snippets and invites the community to join in:

> I'm creating the [RevitAPISnippets GitHub repository](https://github.com/mayconrfreitas/RevitAPISnippets) to
share Revit API code snippets with our Revit developer community.
If you're interested in contributing somehow, I would really appreciate.
The idea is to create an open source project to help developers to improve coding performance.

More about this project in the two-and-a-half-minute video
on [RevitAPISnippets: 170+ code lines in 2 minutes (Revit API)](https://youtu.be/moD7CYUkJHw).

####<a name="5"></a> Batch Processing and Monitoring Progress

Questions on batch processing BIMs come up on a regular basis, and surfaced again discussing 
a [way to check if family is corrupt](https://forums.autodesk.com/t5/revit-api-forum/way-to-check-if-family-is-corrupt/m-p/11174180) with
[pPhillip Miller](https://forums.autodesk.com/t5/user/viewprofilepage/user-id/311888) and
Richard [RPThomas108](https://forums.autodesk.com/t5/user/viewprofilepage/user-id/1035859) Thomas:

**Question:** I have a simple addon that iterates over all the families in a document and exports them to a folder amongst other things, using fam.`SaveAs(path, options)`.

All works as expected until in the very rare case it hits a family that is corrupt.
I know this doesn't happen often but it does happen.
When it hits a family like this there are no warning messages, doesn't crash, just hangs.

My question: Is there a way that I can check for this situation or a way to skip on to the next family?

**Answer:** I don't think so.

You can't cancel the process either so also no possibility of setting a time limit. Only thing you could do is create a logging system where the last item that caused the issue along with those already exported up to that point can be skipped on the next run of the Add-in.

For these kind of issues all you can really do from a API developer perspective is get end user to open a support case with Autodesk regarding the attached project file (or you could open one). A brief review of the journal indicates an issue with many short curves.

Regarding end user support case they can easily replicate the issue outside of the API by attempting to edit the family in the UI. It seems to be getting stuck in a regeneration loop and may eventually resolve. I wouldn't classify it as document corruption because that tends to have an abrupt end i.e. file would not open and error message would be shown in UI. Seems to be an issue with how Revit responds to a certain circumstance that the file causes to arise i.e. problem with Revit.

**Response:** Thanks for your reply.

It was what I thought but just wanted to make sure I wasn't missing anything.

This is meant to be a totally automated process with no user interaction so is a bit of a shame I can't get around this catch and move on.  What I will have to do is set a timer and if there is a long period of time opening a family, pop up a message box of some sort to notify the user of the issue when they get back to their workstation.

**Answer:** Should also mention the `ProgressChangedEventArgs.Cancel` of `Application.ProgressChanged`.

This reports the progress of the little green bar that appears in the bottom left. This has cancel button next to it which is available when opening a family. So it may be possible to cancel via that if you spot a recurring pattern of progress as appears to happen with this family. i.e. how many times it goes to 25% after 50% etc.

ProgressChangedEventArgs.Caption may also report `Regenerating`, so you could also count those and set limits on that.

This all hinges on if ProgressChangedEventArgs.Cancel works, i.e., it works in the UI immediately for the family in question.

Below is an example that seems to work well for English Language Revit.

When you call cancel on the event it throws an exception for the calling method so you can catch that and move onto the next item. The below works by counting the occurrences of "Regenerating", a count of around 2200 is about right for that family (when it starts to loop).

You could as an alternative use the progress Position property but to get a percentage you need to divide the Position property by the UpperRange property. This approach doesn't seem as good as the regen caption approach because the percentages encountered are more random and not a good indicator of a pattern of repetition (would have to store more in an array to check against).

<pre class="code">
  Private IntRegenCount As Integer = 0
  
  Private Sub ProgressChanged(a As Object, e As Autodesk.Revit.DB.Events.ProgressChangedEventArgs)
    If e.Caption = "Regenerating" Then
      IntRegenCount += 1
    End If
    If IntRegenCount > 2200 Then
      'IntRegenCount = 0
      e.Cancel()
    End If
  End Sub

  Public Function Obj_220516d(commandData As ExternalCommandData, ByRef message As String, elements As ElementSet) As Result
    Dim IntUIApp As UIApplication = commandData.Application
    Dim IntUIDoc As UIDocument = commandData.Application.ActiveUIDocument
    Dim IntDoc As Document = IntUIDoc.Document

    AddHandler commandData.Application.Application.ProgressChanged, AddressOf ProgressChanged
    Const NM As String = "Vantage Metro Series Hinged Door Jamb"

    Dim FEC As New FilteredElementCollector(IntDoc)
    Dim ECF As New ElementClassFilter(GetType(Family))
    Dim F As Family = FEC.WherePasses(ECF) _
      .Where(Function(x) x.Name = NM) _
      .Cast(Of Family) _
      .FirstOrDefault

     Dim FDoc As Document = Nothing

    Try
      FDoc = IntDoc.EditFamily(F)
    Catch ex As Exception
      Return Result.Cancelled
    Finally
      RemoveHandler commandData.Application.Application.ProgressChanged, AddressOf ProgressChanged
    End Try

    Return Result.Succeeded

  End Function
</pre>

This below non-language dependant example appears to work also.
In below I attempt to edit the problem family before moving on to a second family in the project file that does open.

Again, you have to look at the numbers for variables N and T below.
The limit of T below often occurs first and seems to give adequate time allowance to edit problem family.

For either case, you have to handle the DialogBoxShowing event to cancel the dialogue that appears after cancelling the progress changed event.

<pre class="code">
  Private IntProgressLog As Integer() = New Integer(20) {}
  
  Private Sub ProgressChanged(s As Object, e As Autodesk.Revit.DB.Events.ProgressChangedEventArgs)
    Dim ULim As Double = e.UpperRange
    Dim Pos As Double = e.Position
    Dim Perc As Integer = ((Pos / ULim) * 20)
    IntProgressLog(Perc) += 1

    Dim N As Integer = IntProgressLog.Max
    Dim T As Integer = IntProgressLog.Sum
    If N > 2000 OrElse T > 15000 Then
      e.Cancel()
    End If
  End Sub
  Private Sub MsgBoxShowing(s As Object, e As Autodesk.Revit.UI.Events.DialogBoxShowingEventArgs)
    Dim IntUIApp As UIApplication = s
    IntProgressLog = New Integer(20) {} 'reset the variable for next family
    e.OverrideResult(2)
  End Sub

  Public Function Obj_220516d(commandData As ExternalCommandData, ByRef message As String, elements As ElementSet) As Result
    Dim IntUIApp As UIApplication = commandData.Application
    Dim IntUIDoc As UIDocument = commandData.Application.ActiveUIDocument
    Dim IntDoc As Document = IntUIDoc.Document

    AddHandler IntUIApp.Application.ProgressChanged, AddressOf ProgressChanged
    AddHandler IntUIApp.DialogBoxShowing, AddressOf MsgBoxShowing

    Dim NM As String() = New String(1) {"Vantage Metro Series Hinged Door Jamb", "_ Callout Head"}

    Dim FDoc As Document = Nothing
    For i = 0 To 1
      Dim K As Integer = i
      Dim FEC As New FilteredElementCollector(IntDoc)
      Dim ECF As New ElementClassFilter(GetType(Family))
      Dim F As Family = FEC.WherePasses(ECF) _
        .Where(Function(x) x.Name = NM(K)) _
        .Cast(Of Family) _
        .FirstOrDefault

      Try
        FDoc = IntDoc.EditFamily(F)
      Catch ex As Exception
      End Try
      If FDoc IsNot Nothing Then
        Debug.WriteLine("Edit of: " & NM(i))
      End If
    Next

    RemoveHandler IntUIApp.Application.ProgressChanged, AddressOf ProgressChanged
    RemoveHandler IntUIApp.DialogBoxShowing, AddressOf MsgBoxShowing

    Return Result.Succeeded
  End Function
</pre>

**Answwer 2:** Following up on some of your initial thoughts, I would assume that this can be totally automated after all, like this:

- Run an external Windows app that monitors progress and can kill Revit.exe by terminating the process via native OS calls
- Loop through all the families and call SaveAs on each, logging progress to an external file (or wherever you like)
- The log file helps keep track of where you are and where you need to proceed next
- If the external file has not been updated for a while (a minute? ten minutes?), kill Revit.exe and restart with the next family to export, logging and skipping the corrupt one

Sound feasible? It is a pretty standard approach to run a batch process.
Revit is not designed for batch processing dozens of files, let alone hundreds or thousands, so crashes of all kinds are to be expected, perfectly normal, and need to be handled gracefully by batch processing workflows.
Check out [The Building Coder 'batch' category](https://thebuildingcoder.typepad.com/blog/batch).

**Response:** Thank you so much.

You have gone way above and beyond with providing examples etc, and I thank you for that.

I'm back working on this project next week and I will let you know how I get on.

Many thanks to Phillip for raising the issue and Richard for his indefatigable help.

<center>
<img src="img/programming_progress_joke.png" alt="Programming progress" title="Programming progress" width="480"/> <!-- 960 -->
</center>

