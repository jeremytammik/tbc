<p><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" type="text/css" href="bc.css">
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js" type="text/javascript"></script>
</head></p>
<!---

- Revit 2018 Code Signing
  https://forums.autodesk.com/t5/revit-api-forum/revit-2018-code-signing/m-p/9715700#M49301
  Peter Hirn's yaml file for RevitLookup helps solve

- preview_control_rotates_model.mp4
  Used PreviewControl ElementHost and PickPoint
  https://forums.autodesk.com/t5/revit-api-forum/used-previewcontrol-elementhost-amp-pickpoint/m-p/9715680

- super cool checks for element type
  Determine if element is ElementType
  https://forums.autodesk.com/t5/revit-api-forum/determine-if-element-is-elementtype/m-p/9713330#M49253

- "Aligning AI With Shared Human Values" https://arxiv.org/pdf/2008.02275v1.pdf

twitter:

 the #RevitAPI @AutodeskForge @AutodeskRevit #bim #DynamoBim #ForgeDevCon 

&ndash; 
...

linkedin:

#bim #DynamoBim #ForgeDevCon #Revit #API #IFC #SDK #AI #VisualStudio #Autodesk #AEC #adsk

the [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread

<center>
<img src="img/" alt="" title="" width="600"/>
<p style="font-size: 80%; font-style:italic"></p>
</center>

-->

<h3>Add-In Code Signing and Element Type Predicates</h3>
<p>Picking up a few interesting threads from
the <a href="http://forums.autodesk.com/t5/revit-api-forum/bd-p/160">Revit API discussion forum</a> and AI:</p>
<ul>
<li><a href="#2">Revit add-in code signing YAML</a></li>
<li><a href="#3">Preview control rotates model</a></li>
<li><a href="#4">Element type predicates</a></li>
<li><a href="#5">AI ethics</a></li>
</ul>
<h4><a name="2"></a>Revit Add-In Code Signing YAML</h4>
<p>Peter Hirn's <a href="https://thebuildingcoder.typepad.com/blog/2020/08/revitlookup-continuous-integration-and-graphql.html#3">YAML file for automating the code signing</a> of
the [continuous integration build of RevitLookup}(https://thebuildingcoder.typepad.com/blog/2020/08/revitlookup-continuous-integration-and-graphql.html#2) helps solve
the <a href="http://forums.autodesk.com/t5/revit-api-forum/bd-p/160">Revit API discussion forum</a> thread
on <a href="https://forums.autodesk.com/t5/revit-api-forum/revit-2018-code-signing/m-p/9715700">Revit 2018 Code Signing</a>:</p>
<p><strong>Question:</strong> I am attempting to code sign my Revit add-in and I can not seem to get Revit to recognize it.
I have a self-signed certificate which I have manually installed into my trusted root authorities, I have built out the add-in in Visual Studio and copied all DLL's and addin file to the addins folder. I have then run the sign tool command:</p>
<pre class="code">
  signtool sign /f "Path/To/codesign.pfx" /t \
    http://timestamp.comodoca.com/authenticode \
    /p "MyPassword" "Path/To/Addins//2018/AppName.dll"
</pre>

<p>This command executes successfully and I can see a digital signatures tab containing the information I added for my self signed certificate in the DLL properties.
Yet, When I start Revit, it still says it is unsigned...
Where did I go wrong?</p>
<p>I have tried various other combinations of this command including passing in the .addin file which errors out saying unrecognized file and signing all dlls in my addins folder.</p>
<p><strong>Answer:</strong> Peter Hirn added an automatic signing step to the <a href="https://thebuildingcoder.typepad.com/blog/2020/08/revitlookup-continuous-integration-and-graphql.html#2">RevitLookup continuous integration on GitLab</a>.</p>
<p>The YAML file executing the add-in signing is available in the <a href="https://github.com/jeremytammik/RevitLookup">RevitLookup GitHub repository</a>.</p>
<p>The pertinent bits are
the <a href="https://github.com/jeremytammik/RevitLookup/blob/master/.gitlab-ci.yml#L53-L79">lines 53-79 in <code>.gitlab-ci.yml</code></a>:</p>
<pre class="prettyprint">
  script:
    - apt-get update && apt-get install -y --no-install-recommends osslsigncode
    - mkdir -p .secrets && mount -t ramfs -o size=1M ramfs .secrets/
    - echo "${CODESIGN_CERTIFICATE}" | base64 --decode > .secrets/authenticode.spc
    - echo "${CODESIGN_KEY}" | base64 --decode > .secrets/authenticode.key
    - osslsigncode -h sha1 -spc .secrets/authenticode.spc -key .secrets/authenticode.key -t ${TIMESERVER} -in "${ASSEMBLY}" -out "${ASSEMBLY}-sha1"
    - osslsigncode -nest -h sha2 -spc .secrets/authenticode.spc -key .secrets/authenticode.key -t ${TIMESERVER} -in "${ASSEMBLY}-sha1" -out "${ASSEMBLY}"
    - rm "${ASSEMBLY}-sha1"
</pre>

<p><strong>Response:</strong> This is great!
I am going to utilize that in my own Repos.
Ok, I finally got windows to recognize my cert;
Let me track through what I did and how I got it to work.</p>
<p>Originally, I was using <code>openssl</code> on a linux server to generate the certs and private keys.
I then used <code>openssl</code> to convert those to a <code>pfx</code> file and was using that to sign stuff;
Looks like that does not work too well.</p>
<p>I followed the post in this thread and that worked...</p>
<p>To rehash what I did to make this work:</p>
<p>Notes before you begin: <code>MakeCert.exe</code>, <code>pvk2pfx.exe</code>, and <code>signtool.exe</code> are all located in *C:\Program Files (x86)\Windows Kits\8.1\bin\x64*.
I have already added this to my environment variables; make sure you do so too, otherwise you will have to specify in your command where to find these exes.</p>
<pre class="code">
MakeCert.exe -r -sv AVT_CodeSign.pvk -n "CN=AVT" AVTCodeSign.cer -b 01/01/2020 -e 12/31/2020
</pre>

<p>NOTE: MakeCert is deprecated according to official Microsoft sources, but at the time of this writing that command still works.
They have an alternative Powershell commandlet that does the same thing though I did not try that since MakeCert worked for me.</p>
<pre class="code">
pvk2pfx.exe -pvk codesign.pvk -pi MySecurePassword -spc codesign.cer -pfx codesign.pfx -po MyOtherSecurePassword
</pre>

<p>NOTE: The passwords can be the same here; The password I'm using here is from a prompt from Step 1.
That prompt will ask you to supply a password for the private key or give you the option to press "none".
Whichever you choose, supply that password in step 2.</p>
<p>Step 3: Use <code>CertMgr.msc</code> to install your <code>codesign.pfx</code> file NOT the certificate.
Install it Trusted Publishers, then in Trusted Root Certification Authorities</p>
<p>NOTE: It's important here to click your <code>.pfx</code> file as when I did this step, the default was choosing the cert file.
I'm unsure if this way is better than simply right clicking and hitting "install cert" but it seems both will get you to the same spot.</p>
<pre class="code">
signtool sign /f "Path\To\codesign.pfx" /t http://timestamp.verisign.com/scripts/timstamp.dll /p "MySecurePassword" "Path\To\RevitAddin.dll"
</pre>

<p>Following this process I was able to get a valid digital signature.
I'm not sure why generating it using <code>openssl</code> on linux was causing an issue but there may be something to this method that works better.</p>
<p>Many thanks to ShinyKey for testing and confirming this, and thanks again to Peter Hirn for the smooth RevitLookup CI and code signing workflow.</p>
<h4><a name="3"></a>Preview Control Rotates Model</h4>
<p>Scott Ehrenworth of <a href="https://www.microdesk.com">Microdesk Inc.</a> poited out a few interesting aspects of using and interacting with the Revit API <a href="https://www.revitapidocs.com/2020/50112279-5c9d-0351-bbd1-698e76be9e36.htm">PreviewControl class</a> in
the <a href="http://forums.autodesk.com/t5/revit-api-forum/bd-p/160">Revit API discussion forum</a> thread
on <a href="https://forums.autodesk.com/t5/revit-api-forum/used-previewcontrol-elementhost-amp-pickpoint/m-p/9715680">Using PreviewControl ElementHost and PickPoint</a>:</p>
<p>Firstly, The <code>PreviewControl</code> is <u>not</u> a pure preview control, providing read-only access and no user interaction with the model.</p>
<p>Proof: When changing the orientation or rotation of a 3D view inside of a <code>PreviewControl</code> window, the model's 3D view will rotate as well:</p>
<p><center>
<video style="display:block; width:600px; height:auto;" autoplay="" muted="" loop="loop">
<source src="img/preview_control_rotates_model.mp4" type="video/mp4">
<source src="https://thebuildingcoder.typepad.com/2020/banana_small.mp4" type="video/mp4">
</video>
</center></p>
<p>Zoom and Pan do not have this effect.</p>
<p>Secodnly, even though the preview control modifies the model's current view settings, it does not require a transaction to do so.
However, it does require the manual transaction option, presumably so that it can start and commit its own transaction internally.</p>
<p>This could be like the <code>PromptForFamilyInstancePlacement</code> method that has a transaction control built in.
The PreviewControl class is full of Event Handlers, so maybe this is the case?</p>
<p>Here's the very basic sample of the external command I used to test this for 3D views.</p>
<pre class="code">
  [Transaction(TransactionMode.Manual)]
  class PreviewControlTest : IExternalCommand
  {
    public Result Execute(
      ExternalCommandData commandData,
      ref string message,
      ElementSet elements)
    {
      UIApplication uiapp = commandData.Application;
      UIDocument uidoc = uiapp.ActiveUIDocument;
      Document doc = uidoc.Document;

      WPF_GridContainer newGrid = new WPF_GridContainer();

      newGrid.theGrid.Children.Add( new PreviewControl( doc,
        new FilteredElementCollector(doc)
          .OfClass(typeof(View3D))
          .FirstElementId()));

      newGrid.ShowDialog();

      return Result.Succeeded;
    }
  }
</pre>

<p>I assume it will refuse to run in read-only transaction mode, then...</p>
<p>Yes, I can confirm:</p>
<p>Switching the <code>TransactionMode</code> to <code>ReadOnly</code> is now just hanging the command (never opens the window for the PreviewControl).</p>
<p>Funky stuff, but good to know!</p>
<p>Many thanks to Scott for this useful information and research.</p>
<p>For pointers to several previous discussions of various aspects of the <code>PreviewControl</code>, check out the post
on <a href="https://thebuildingcoder.typepad.com/blog/2013/09/appstore-advice-and-zooming-in-a-preview-control.html#4">zooming in a preview control</a>.</p>
<h4><a name="4"></a>Element Type Predicates</h4>
<p>Here are a bunch of ways to check and filter for Revit element types making use of both .NET generics and the Revit API filtering functionality suggested in the question on how 
to <a href="https://forums.autodesk.com/t5/revit-api-forum/determine-if-element-is-elementtype/m-p/9713330">determine if element is <code>ElementType</code></a>:</p>
<p><strong>Question:</strong> I'm listening to the <code>Application</code> <code>DocumentChanged</code> event and would like to see if the element modified is an Instance or an ElementType.
I'm currently doing the following but it doesn't quite satisfy all the conditions:</p>
<pre class="code">
static bool IsElementType(Element element)
{
    var typeId = element?.GetTypeId();
    if (typeId == null || typeId == ElementId.InvalidElementId)
    {
        if (!(element is Room) && !(element is PipeSegment))
        {
            return true;
        }
    }    
    return false;
}
</pre>

<p>I'm not native to Revit sorry if my terminology is off.
How does the <code>FilterCollector.WhereElementIsElementType()</code> determine it's an ElementType?</p>
<p><strong>Answer:</strong> This will return false if type is <code>ElementType</code> but true if is derived from <code>ElementType</code>:</p>
<pre class="code">
  bool Bl = element.GetType().IsSubclassOf(typeof(ElementType));
</pre>

<p>This will return true if type is ElementType or is derived from ElementType:</p>
<pre class="code">
  bool B2 = typeof(ElementType).IsAssignableFrom(element.GetType());
</pre>

<p>Here's a more Revit orientated approach in VB: you asked how a collector determines an ElementType, but you can always pass a list of a single element into a collector and filter that:</p>
<pre class="code">
  Dim FEC As New FilteredElementCollector(element.Document, {element.Id}.ToList)
  Dim B3 As Boolean = FEC.WhereElementIsElementType.ToElementIds.Count > 0
</pre>

<p>You can't do it in C# in this abbreviated fashion due to the need to use <code>ICollection&amp;lt;T&amp;gt;</code> directly (option <code>Strict</code> <code>off</code> in VB), but you can do similar.</p>
<p><strong>Answer 2:</strong> Here's a simpler way of putting it:</p>
<pre class="code">
  static bool IsElementType(Element element)
  {
    return element is ElementType;
  }
</pre>

<p>I'd suggest not even making a method for this and just using the <code>is</code> expression.</p>
<p><strong>Answer 3:</strong> I use the <code>is</code> operator quite often in my work.</p>
<p>Here is an online method which will use a <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/is#type-pattern">type pattern</a> to give you the <code>EType</code> as a variable:</p>
<pre class="code">
  if(element is ElementType EType)
  {
    TaskDialog.Show("Type Name",EType.Name);
  }
</pre>

<p>Interesting to note that in VB the <code>is</code> statement only returns true if the exact same type is compared.
Since <code>is</code> is used to check if two things are the same object instance.
The equivalent to the way it is used in C# seems to be:</p>
<pre class="code">
  Dim B1 As Boolean = TypeOf Element Is ElementType
</pre>

<h4><a name="5"></a>AI Ethics</h4>
<p>A very interesting and promising first stab at creating 'good' AI and NLP that conforms with common human ethical judgement and behaviour is presented in the research paper 
on <a href="https://arxiv.org/pdf/2008.02275v1.pdf">Aligning AI With Shared Human Values</a>.</p>